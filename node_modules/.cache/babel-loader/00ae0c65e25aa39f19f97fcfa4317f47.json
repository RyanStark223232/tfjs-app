{"ast":null,"code":"import _slicedToArray from \"C:/Users/wongh/Documents/GitHub/tfjs-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\n\n/**\r\n * @license\r\n * Copyright 2020 Google LLC. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\nimport { Max } from '@tensorflow/tfjs-core';\nimport { backend_util, util } from '@tensorflow/tfjs-core';\nimport { maxImplCPU } from '../kernel_utils/shared';\nimport { maxImpl } from './Max_impl';\nimport { transposeImpl, transposeImplCPU } from './Transpose_impl';\nexport var maxConfig = {\n  kernelName: Max,\n  backendName: 'webgl',\n  kernelFunc: function kernelFunc(_ref) {\n    var inputs = _ref.inputs,\n        attrs = _ref.attrs,\n        backend = _ref.backend;\n    var x = inputs.x;\n    var reductionIndices = attrs.reductionIndices,\n        keepDims = attrs.keepDims;\n    var webglBackend = backend;\n    var xRank = x.shape.length;\n    var origAxes = util.parseAxisParam(reductionIndices, x.shape);\n    var axes = origAxes;\n    var permutedAxes = backend_util.getAxesPermutation(axes, xRank);\n    var maxInputIsTransposed = permutedAxes != null;\n    var shouldExecuteOnCPU = webglBackend.shouldExecuteOnCPU([x]);\n    var maxInput = x;\n\n    if (maxInputIsTransposed) {\n      if (shouldExecuteOnCPU) {\n        var xTexData = webglBackend.texData.get(maxInput.dataId);\n        var values = xTexData.values;\n        var newShape = new Array(xRank);\n\n        for (var i = 0; i < newShape.length; i++) {\n          newShape[i] = x.shape[permutedAxes[i]];\n        }\n\n        var maxInputValues = transposeImplCPU(values, x.shape, x.dtype, permutedAxes, newShape);\n        maxInput = webglBackend.makeTensorInfo(newShape, x.dtype);\n        var maxInputData = webglBackend.texData.get(maxInput.dataId);\n        maxInputData.values = maxInputValues;\n      } else {\n        maxInput = transposeImpl(x, permutedAxes, webglBackend);\n      }\n\n      axes = backend_util.getInnerMostAxes(axes.length, xRank);\n    }\n\n    backend_util.assertAxesAreInnerMostDims('max', axes, xRank);\n\n    var _backend_util$compute = backend_util.computeOutAndReduceShapes(maxInput.shape, axes),\n        _backend_util$compute2 = _slicedToArray(_backend_util$compute, 2),\n        maxOutShape = _backend_util$compute2[0],\n        reduceShape = _backend_util$compute2[1];\n\n    var outShape = maxOutShape;\n\n    if (keepDims) {\n      // rather than reshape at the end, set the target shape here.\n      outShape = backend_util.expandShapeToKeepDim(maxOutShape, origAxes);\n    }\n\n    var out;\n\n    if (shouldExecuteOnCPU) {\n      var _xTexData = webglBackend.texData.get(maxInput.dataId);\n\n      var _values = _xTexData.values;\n      var outValues = maxImplCPU(_values, util.sizeFromShape(reduceShape), outShape, x.dtype);\n      out = webglBackend.makeTensorInfo(outShape, x.dtype);\n      var outData = webglBackend.texData.get(out.dataId);\n      outData.values = outValues;\n    } else {\n      out = maxImpl(maxInput, reduceShape, outShape, webglBackend);\n    }\n\n    if (maxInputIsTransposed) {\n      webglBackend.disposeIntermediateTensorInfo(maxInput);\n    }\n\n    return out;\n  }\n};","map":{"version":3,"sources":["../../src/kernels/Max.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * @license\r\n * Copyright 2020 Google LLC. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\nimport { Max } from '@tensorflow/tfjs-core';\r\nimport { backend_util, util } from '@tensorflow/tfjs-core';\r\nimport { maxImplCPU } from '../kernel_utils/shared';\r\nimport { maxImpl } from './Max_impl';\r\nimport { transposeImpl, transposeImplCPU } from './Transpose_impl';\r\nexport const maxConfig = {\r\n    kernelName: Max,\r\n    backendName: 'webgl',\r\n    kernelFunc: ({ inputs, attrs, backend }) => {\r\n        const { x } = inputs;\r\n        const { reductionIndices, keepDims } = attrs;\r\n        const webglBackend = backend;\r\n        const xRank = x.shape.length;\r\n        const origAxes = util.parseAxisParam(reductionIndices, x.shape);\r\n        let axes = origAxes;\r\n        const permutedAxes = backend_util.getAxesPermutation(axes, xRank);\r\n        const maxInputIsTransposed = permutedAxes != null;\r\n        const shouldExecuteOnCPU = webglBackend.shouldExecuteOnCPU([x]);\r\n        let maxInput = x;\r\n        if (maxInputIsTransposed) {\r\n            if (shouldExecuteOnCPU) {\r\n                const xTexData = webglBackend.texData.get(maxInput.dataId);\r\n                const values = xTexData.values;\r\n                const newShape = new Array(xRank);\r\n                for (let i = 0; i < newShape.length; i++) {\r\n                    newShape[i] = x.shape[permutedAxes[i]];\r\n                }\r\n                const maxInputValues = transposeImplCPU(values, x.shape, x.dtype, permutedAxes, newShape);\r\n                maxInput = webglBackend.makeTensorInfo(newShape, x.dtype);\r\n                const maxInputData = webglBackend.texData.get(maxInput.dataId);\r\n                maxInputData.values = maxInputValues;\r\n            }\r\n            else {\r\n                maxInput = transposeImpl(x, permutedAxes, webglBackend);\r\n            }\r\n            axes = backend_util.getInnerMostAxes(axes.length, xRank);\r\n        }\r\n        backend_util.assertAxesAreInnerMostDims('max', axes, xRank);\r\n        const [maxOutShape, reduceShape] = backend_util.computeOutAndReduceShapes(maxInput.shape, axes);\r\n        let outShape = maxOutShape;\r\n        if (keepDims) {\r\n            // rather than reshape at the end, set the target shape here.\r\n            outShape = backend_util.expandShapeToKeepDim(maxOutShape, origAxes);\r\n        }\r\n        let out;\r\n        if (shouldExecuteOnCPU) {\r\n            const xTexData = webglBackend.texData.get(maxInput.dataId);\r\n            const values = xTexData.values;\r\n            const outValues = maxImplCPU(values, util.sizeFromShape(reduceShape), outShape, x.dtype);\r\n            out = webglBackend.makeTensorInfo(outShape, x.dtype);\r\n            const outData = webglBackend.texData.get(out.dataId);\r\n            outData.values = outValues;\r\n        }\r\n        else {\r\n            out = maxImpl(maxInput, reduceShape, outShape, webglBackend);\r\n        }\r\n        if (maxInputIsTransposed) {\r\n            webglBackend.disposeIntermediateTensorInfo(maxInput);\r\n        }\r\n        return out;\r\n    }\r\n};\r\n//# sourceMappingURL=Max.js.map"]},"metadata":{},"sourceType":"module"}