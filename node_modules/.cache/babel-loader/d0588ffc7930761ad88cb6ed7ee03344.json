{"ast":null,"code":"/**\r\n * @license\r\n * Copyright 2018 Google LLC. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\n// tslint:disable-next-line: no-imports-from-dist\nimport * as tfOps from '@tensorflow/tfjs-core/dist/ops/ops_for_converter';\nimport { getPadding, getParamValue } from './utils';\n\nfunction fusedConvAndDepthWiseParams(node, tensorMap, context) {\n  const [extraOp, activationFunc] = getParamValue('fusedOps', node, tensorMap, context);\n  const isBiasAdd = extraOp === 'biasadd';\n  const isPrelu = activationFunc === 'prelu';\n  const isBatchNorm = extraOp === 'fusedbatchnorm';\n  const numArgs = getParamValue('numArgs', node, tensorMap, context);\n\n  if (isBiasAdd) {\n    if (isPrelu && numArgs !== 2) {\n      throw new Error('FusedConv2d and DepthwiseConv2d with BiasAdd and Prelu ' + 'must have two extra arguments: bias and alpha.');\n    }\n\n    if (!isPrelu && numArgs !== 1) {\n      throw new Error('FusedConv2d and DepthwiseConv2d with BiasAdd must have ' + 'one extra argument: bias.');\n    }\n  }\n\n  if (isBatchNorm) {\n    throw new Error('FusedConv2d and DepthwiseConv2d with FusedBatchNorm is not supported.');\n  }\n\n  const stride = getParamValue('strides', node, tensorMap, context);\n  const pad = getPadding(node, tensorMap, context);\n  const dataFormat = getParamValue('dataFormat', node, tensorMap, context).toUpperCase();\n  const dilations = getParamValue('dilations', node, tensorMap, context);\n  const [biasArg, preluArg] = getParamValue('args', node, tensorMap, context);\n  return {\n    stride,\n    pad,\n    dataFormat,\n    dilations,\n    biasArg,\n    preluArg,\n    activationFunc\n  };\n}\n\nexport const executeOp = (node, tensorMap, context) => {\n  switch (node.op) {\n    case 'Conv1D':\n      {\n        const stride = getParamValue('stride', node, tensorMap, context);\n        const pad = getParamValue('pad', node, tensorMap, context);\n        const dataFormat = getParamValue('dataFormat', node, tensorMap, context).toUpperCase();\n        const dilation = getParamValue('dilation', node, tensorMap, context);\n        return [tfOps.conv1d(getParamValue('x', node, tensorMap, context), getParamValue('filter', node, tensorMap, context), stride, pad, dataFormat, dilation)];\n      }\n\n    case 'Conv2D':\n      {\n        const stride = getParamValue('strides', node, tensorMap, context);\n        const pad = getPadding(node, tensorMap, context);\n        const dataFormat = getParamValue('dataFormat', node, tensorMap, context).toUpperCase();\n        const dilations = getParamValue('dilations', node, tensorMap, context);\n        return [tfOps.conv2d(getParamValue('x', node, tensorMap, context), getParamValue('filter', node, tensorMap, context), [stride[1], stride[2]], pad, dataFormat, [dilations[1], dilations[2]])];\n      }\n\n    case '_FusedConv2D':\n      {\n        const {\n          stride,\n          pad,\n          dataFormat,\n          dilations,\n          biasArg,\n          preluArg,\n          activationFunc\n        } = fusedConvAndDepthWiseParams(node, tensorMap, context);\n        return [tfOps.fused.conv2d({\n          x: getParamValue('x', node, tensorMap, context),\n          filter: getParamValue('filter', node, tensorMap, context),\n          strides: [stride[1], stride[2]],\n          pad: pad,\n          dataFormat: dataFormat,\n          dilations: [dilations[1], dilations[2]],\n          bias: biasArg,\n          activation: activationFunc,\n          preluActivationWeights: preluArg\n        })];\n      }\n\n    case 'FusedDepthwiseConv2dNative':\n      {\n        const {\n          stride,\n          pad,\n          dataFormat,\n          dilations,\n          biasArg,\n          preluArg,\n          activationFunc\n        } = fusedConvAndDepthWiseParams(node, tensorMap, context);\n        return [tfOps.fused.depthwiseConv2d({\n          x: getParamValue('x', node, tensorMap, context),\n          filter: getParamValue('filter', node, tensorMap, context),\n          strides: [stride[1], stride[2]],\n          pad: pad,\n          dataFormat: dataFormat,\n          dilations: [dilations[1], dilations[2]],\n          bias: biasArg,\n          activation: activationFunc,\n          preluActivationWeights: preluArg\n        })];\n      }\n\n    case 'Conv2DBackpropInput':\n    case 'Conv2dTranspose':\n      {\n        const shape = getParamValue('outputShape', node, tensorMap, context);\n        const stride = getParamValue('strides', node, tensorMap, context);\n        const pad = getPadding(node, tensorMap, context);\n        return [tfOps.conv2dTranspose(getParamValue('x', node, tensorMap, context), getParamValue('filter', node, tensorMap, context), shape, [stride[1], stride[2]], pad)];\n      }\n\n    case 'DepthwiseConv2dNative':\n    case 'DepthwiseConv2d':\n      {\n        const stride = getParamValue('strides', node, tensorMap, context);\n        const pad = getPadding(node, tensorMap, context);\n        const dilations = getParamValue('dilations', node, tensorMap, context);\n        const dataFormat = getParamValue('dataFormat', node, tensorMap, context).toUpperCase();\n        return [tfOps.depthwiseConv2d(getParamValue('input', node, tensorMap, context), getParamValue('filter', node, tensorMap, context), [stride[1], stride[2]], pad, dataFormat, [dilations[1], dilations[2]])];\n      }\n\n    case 'Conv3D':\n      {\n        const stride = getParamValue('strides', node, tensorMap, context);\n        const pad = getParamValue('pad', node, tensorMap, context);\n        const dataFormat = getParamValue('dataFormat', node, tensorMap, context).toUpperCase();\n        const dilations = getParamValue('dilations', node, tensorMap, context);\n        return [tfOps.conv3d(getParamValue('x', node, tensorMap, context), getParamValue('filter', node, tensorMap, context), [stride[1], stride[2], stride[3]], pad, dataFormat, [dilations[1], dilations[2], dilations[3]])];\n      }\n\n    case 'AvgPool':\n      {\n        const stride = getParamValue('strides', node, tensorMap, context);\n        const pad = getParamValue('pad', node, tensorMap, context);\n        const kernelSize = getParamValue('kernelSize', node, tensorMap, context);\n        return [tfOps.avgPool(getParamValue('x', node, tensorMap, context), [kernelSize[1], kernelSize[2]], [stride[1], stride[2]], pad)];\n      }\n\n    case 'MaxPool':\n      {\n        const stride = getParamValue('strides', node, tensorMap, context);\n        const pad = getParamValue('pad', node, tensorMap, context);\n        const kernelSize = getParamValue('kernelSize', node, tensorMap, context);\n        return [tfOps.maxPool(getParamValue('x', node, tensorMap, context), [kernelSize[1], kernelSize[2]], [stride[1], stride[2]], pad)];\n      }\n\n    case 'MaxPoolWithArgmax':\n      {\n        const stride = getParamValue('strides', node, tensorMap, context);\n        const pad = getParamValue('pad', node, tensorMap, context);\n        const kernelSize = getParamValue('kernelSize', node, tensorMap, context);\n        const includeBatchInIndex = getParamValue('includeBatchInIndex', node, tensorMap, context);\n        const {\n          result,\n          indexes\n        } = tfOps.maxPoolWithArgmax(getParamValue('x', node, tensorMap, context), [kernelSize[1], kernelSize[2]], [stride[1], stride[2]], pad, includeBatchInIndex);\n        return [result, indexes];\n      }\n\n    case 'AvgPool3D':\n      {\n        const stride = getParamValue('strides', node, tensorMap, context);\n        const pad = getParamValue('pad', node, tensorMap, context);\n        const kernelSize = getParamValue('kernelSize', node, tensorMap, context);\n        return [tfOps.avgPool3d(getParamValue('x', node, tensorMap, context), [kernelSize[1], kernelSize[2], kernelSize[3]], [stride[1], stride[2], stride[3]], pad)];\n      }\n\n    case 'MaxPool3D':\n      {\n        const stride = getParamValue('strides', node, tensorMap, context);\n        const pad = getParamValue('pad', node, tensorMap, context);\n        const kernelSize = getParamValue('kernelSize', node, tensorMap, context);\n        return [tfOps.maxPool3d(getParamValue('x', node, tensorMap, context), [kernelSize[1], kernelSize[2], kernelSize[3]], [stride[1], stride[2], stride[3]], pad)];\n      }\n\n    case 'Dilation2D':\n      {\n        const strides = getParamValue('strides', node, tensorMap, context);\n        const pad = getParamValue('pad', node, tensorMap, context);\n        const dilations = getParamValue('dilations', node, tensorMap, context); // strides: [1, stride_height, stride_width, 1].\n\n        const strideHeight = strides[1];\n        const strideWidth = strides[2]; // dilations: [1, dilation_height, dilation_width, 1].\n\n        const dilationHeight = dilations[1];\n        const dilationWidth = dilations[2];\n        return [tfOps.dilation2d(getParamValue('x', node, tensorMap, context), getParamValue('filter', node, tensorMap, context), [strideHeight, strideWidth], pad, [dilationHeight, dilationWidth], 'NHWC'\n        /* dataFormat */\n        )];\n      }\n\n    default:\n      throw TypeError(`Node type ${node.op} is not implemented`);\n  }\n};\nexport const CATEGORY = 'convolution';","map":{"version":3,"sources":["../../../src/operations/executors/convolution_executor.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * @license\r\n * Copyright 2018 Google LLC. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n// tslint:disable-next-line: no-imports-from-dist\r\nimport * as tfOps from '@tensorflow/tfjs-core/dist/ops/ops_for_converter';\r\nimport { getPadding, getParamValue } from './utils';\r\nfunction fusedConvAndDepthWiseParams(node, tensorMap, context) {\r\n    const [extraOp, activationFunc] = getParamValue('fusedOps', node, tensorMap, context);\r\n    const isBiasAdd = extraOp === 'biasadd';\r\n    const isPrelu = activationFunc === 'prelu';\r\n    const isBatchNorm = extraOp === 'fusedbatchnorm';\r\n    const numArgs = getParamValue('numArgs', node, tensorMap, context);\r\n    if (isBiasAdd) {\r\n        if (isPrelu && numArgs !== 2) {\r\n            throw new Error('FusedConv2d and DepthwiseConv2d with BiasAdd and Prelu ' +\r\n                'must have two extra arguments: bias and alpha.');\r\n        }\r\n        if (!isPrelu && numArgs !== 1) {\r\n            throw new Error('FusedConv2d and DepthwiseConv2d with BiasAdd must have ' +\r\n                'one extra argument: bias.');\r\n        }\r\n    }\r\n    if (isBatchNorm) {\r\n        throw new Error('FusedConv2d and DepthwiseConv2d with FusedBatchNorm is not supported.');\r\n    }\r\n    const stride = getParamValue('strides', node, tensorMap, context);\r\n    const pad = getPadding(node, tensorMap, context);\r\n    const dataFormat = getParamValue('dataFormat', node, tensorMap, context)\r\n        .toUpperCase();\r\n    const dilations = getParamValue('dilations', node, tensorMap, context);\r\n    const [biasArg, preluArg] = getParamValue('args', node, tensorMap, context);\r\n    return {\r\n        stride,\r\n        pad,\r\n        dataFormat,\r\n        dilations,\r\n        biasArg,\r\n        preluArg,\r\n        activationFunc\r\n    };\r\n}\r\nexport const executeOp = (node, tensorMap, context) => {\r\n    switch (node.op) {\r\n        case 'Conv1D': {\r\n            const stride = getParamValue('stride', node, tensorMap, context);\r\n            const pad = getParamValue('pad', node, tensorMap, context);\r\n            const dataFormat = getParamValue('dataFormat', node, tensorMap, context)\r\n                .toUpperCase();\r\n            const dilation = getParamValue('dilation', node, tensorMap, context);\r\n            return [tfOps.conv1d(getParamValue('x', node, tensorMap, context), getParamValue('filter', node, tensorMap, context), stride, pad, dataFormat, dilation)];\r\n        }\r\n        case 'Conv2D': {\r\n            const stride = getParamValue('strides', node, tensorMap, context);\r\n            const pad = getPadding(node, tensorMap, context);\r\n            const dataFormat = getParamValue('dataFormat', node, tensorMap, context)\r\n                .toUpperCase();\r\n            const dilations = getParamValue('dilations', node, tensorMap, context);\r\n            return [tfOps.conv2d(getParamValue('x', node, tensorMap, context), getParamValue('filter', node, tensorMap, context), [stride[1], stride[2]], pad, dataFormat, [dilations[1], dilations[2]])];\r\n        }\r\n        case '_FusedConv2D': {\r\n            const { stride, pad, dataFormat, dilations, biasArg, preluArg, activationFunc } = fusedConvAndDepthWiseParams(node, tensorMap, context);\r\n            return [tfOps.fused.conv2d({\r\n                    x: getParamValue('x', node, tensorMap, context),\r\n                    filter: getParamValue('filter', node, tensorMap, context),\r\n                    strides: [stride[1], stride[2]],\r\n                    pad: pad,\r\n                    dataFormat: dataFormat,\r\n                    dilations: [dilations[1], dilations[2]],\r\n                    bias: biasArg,\r\n                    activation: activationFunc,\r\n                    preluActivationWeights: preluArg\r\n                })];\r\n        }\r\n        case 'FusedDepthwiseConv2dNative': {\r\n            const { stride, pad, dataFormat, dilations, biasArg, preluArg, activationFunc } = fusedConvAndDepthWiseParams(node, tensorMap, context);\r\n            return [tfOps.fused.depthwiseConv2d({\r\n                    x: getParamValue('x', node, tensorMap, context),\r\n                    filter: getParamValue('filter', node, tensorMap, context),\r\n                    strides: [stride[1], stride[2]],\r\n                    pad: pad,\r\n                    dataFormat: dataFormat,\r\n                    dilations: [dilations[1], dilations[2]],\r\n                    bias: biasArg,\r\n                    activation: activationFunc,\r\n                    preluActivationWeights: preluArg\r\n                })];\r\n        }\r\n        case 'Conv2DBackpropInput':\r\n        case 'Conv2dTranspose': {\r\n            const shape = getParamValue('outputShape', node, tensorMap, context);\r\n            const stride = getParamValue('strides', node, tensorMap, context);\r\n            const pad = getPadding(node, tensorMap, context);\r\n            return [tfOps.conv2dTranspose(getParamValue('x', node, tensorMap, context), getParamValue('filter', node, tensorMap, context), shape, [stride[1], stride[2]], pad)];\r\n        }\r\n        case 'DepthwiseConv2dNative':\r\n        case 'DepthwiseConv2d': {\r\n            const stride = getParamValue('strides', node, tensorMap, context);\r\n            const pad = getPadding(node, tensorMap, context);\r\n            const dilations = getParamValue('dilations', node, tensorMap, context);\r\n            const dataFormat = getParamValue('dataFormat', node, tensorMap, context)\r\n                .toUpperCase();\r\n            return [tfOps.depthwiseConv2d(getParamValue('input', node, tensorMap, context), getParamValue('filter', node, tensorMap, context), [stride[1], stride[2]], pad, dataFormat, [dilations[1], dilations[2]])];\r\n        }\r\n        case 'Conv3D': {\r\n            const stride = getParamValue('strides', node, tensorMap, context);\r\n            const pad = getParamValue('pad', node, tensorMap, context);\r\n            const dataFormat = getParamValue('dataFormat', node, tensorMap, context)\r\n                .toUpperCase();\r\n            const dilations = getParamValue('dilations', node, tensorMap, context);\r\n            return [tfOps.conv3d(getParamValue('x', node, tensorMap, context), getParamValue('filter', node, tensorMap, context), [stride[1], stride[2], stride[3]], pad, dataFormat, [dilations[1], dilations[2], dilations[3]])];\r\n        }\r\n        case 'AvgPool': {\r\n            const stride = getParamValue('strides', node, tensorMap, context);\r\n            const pad = getParamValue('pad', node, tensorMap, context);\r\n            const kernelSize = getParamValue('kernelSize', node, tensorMap, context);\r\n            return [tfOps.avgPool(getParamValue('x', node, tensorMap, context), [kernelSize[1], kernelSize[2]], [stride[1], stride[2]], pad)];\r\n        }\r\n        case 'MaxPool': {\r\n            const stride = getParamValue('strides', node, tensorMap, context);\r\n            const pad = getParamValue('pad', node, tensorMap, context);\r\n            const kernelSize = getParamValue('kernelSize', node, tensorMap, context);\r\n            return [tfOps.maxPool(getParamValue('x', node, tensorMap, context), [kernelSize[1], kernelSize[2]], [stride[1], stride[2]], pad)];\r\n        }\r\n        case 'MaxPoolWithArgmax': {\r\n            const stride = getParamValue('strides', node, tensorMap, context);\r\n            const pad = getParamValue('pad', node, tensorMap, context);\r\n            const kernelSize = getParamValue('kernelSize', node, tensorMap, context);\r\n            const includeBatchInIndex = getParamValue('includeBatchInIndex', node, tensorMap, context);\r\n            const { result, indexes } = tfOps.maxPoolWithArgmax(getParamValue('x', node, tensorMap, context), [kernelSize[1], kernelSize[2]], [stride[1], stride[2]], pad, includeBatchInIndex);\r\n            return [result, indexes];\r\n        }\r\n        case 'AvgPool3D': {\r\n            const stride = getParamValue('strides', node, tensorMap, context);\r\n            const pad = getParamValue('pad', node, tensorMap, context);\r\n            const kernelSize = getParamValue('kernelSize', node, tensorMap, context);\r\n            return [tfOps.avgPool3d(getParamValue('x', node, tensorMap, context), [kernelSize[1], kernelSize[2], kernelSize[3]], [stride[1], stride[2], stride[3]], pad)];\r\n        }\r\n        case 'MaxPool3D': {\r\n            const stride = getParamValue('strides', node, tensorMap, context);\r\n            const pad = getParamValue('pad', node, tensorMap, context);\r\n            const kernelSize = getParamValue('kernelSize', node, tensorMap, context);\r\n            return [tfOps.maxPool3d(getParamValue('x', node, tensorMap, context), [kernelSize[1], kernelSize[2], kernelSize[3]], [stride[1], stride[2], stride[3]], pad)];\r\n        }\r\n        case 'Dilation2D': {\r\n            const strides = getParamValue('strides', node, tensorMap, context);\r\n            const pad = getParamValue('pad', node, tensorMap, context);\r\n            const dilations = getParamValue('dilations', node, tensorMap, context);\r\n            // strides: [1, stride_height, stride_width, 1].\r\n            const strideHeight = strides[1];\r\n            const strideWidth = strides[2];\r\n            // dilations: [1, dilation_height, dilation_width, 1].\r\n            const dilationHeight = dilations[1];\r\n            const dilationWidth = dilations[2];\r\n            return [tfOps.dilation2d(getParamValue('x', node, tensorMap, context), getParamValue('filter', node, tensorMap, context), [strideHeight, strideWidth], pad, [dilationHeight, dilationWidth], 'NHWC' /* dataFormat */)];\r\n        }\r\n        default:\r\n            throw TypeError(`Node type ${node.op} is not implemented`);\r\n    }\r\n};\r\nexport const CATEGORY = 'convolution';\r\n//# sourceMappingURL=convolution_executor.js.map"]},"metadata":{},"sourceType":"module"}